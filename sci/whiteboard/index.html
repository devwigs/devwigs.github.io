<!DOCTYPE html>
<html lang="en-ca">
<head>
<meta charset="utf8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Whiteboard</title>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script type="text/javascript" src="../script/plot.js"></script>
<script type="text/javascript" src="../script/touch.js"></script>
<link rel="shortcut icon" type="image/x-icon" href="../media/favicon.ico"/>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Oxygen:400,700"/>
<style type="text/css">

body {
    margin:0;
    background-color:#d0d0d0;
}

canvas {
    position:absolute;
    top:36px;
    left:0;
}

button {
    width:4em;
    margin:0;
    padding:4px;
    text-align:center;
}

table {
    position:fixed;
    top:2px; left:4px;
    background-color:white;
    border-collapse:collapse;
    z-index:999;
}

td {
    text-align:center;
    border:1px solid black;
    width:20px;
    height:20px;
    overflow:hidden;
    cursor:pointer;
}

.black {background-color:black}
.blue {background-color:blue}
.red {background-color:red}
.purple {background-color:violet}
.green {background-color:forestgreen}

</style>
<script type="text/javascript">

let cx, pos;

function draw(start, end) {
    let x = start[0];
    let y = start[1];
    let dx = end[0] - x;
    let dy = end[1] - y;
    let r = Math.sqrt(dx*dx + dy*dy);
    for (let i=0; i<r; i++) {
        dot(x + i/r*dx, y + i/r*dy);
    }
    dot(end[0], end[1]);
}

window.onmouseup = window.ontouchend = function() {pos = null; sync()}

let dy = -36;

function setPos(ev) {
    pos = [ev.clientX + window.scrollX, ev.clientY + dy];
}

function move(ev) {
    if (pos) {
        let newPos = [ev.clientX + window.scrollX, ev.clientY + dy];
        draw(pos, newPos);
        pos = newPos;
    }
}

function touch(ev) {
    let c = ev.target == $("canvas")[0];
    ev.preventDefault();
    ev = ev.originalEvent.touches[0];
    if (!pos) {
        pos = [ev.clientX + window.scrollX, ev.clientY + dy];
        if (c) dot();
    }
    else move(ev);
}

function dot(x, y) {
    if (x == null) {
        x = pos[0];
        y = pos[1];
    }
    let w = cx.lineWidth / 2;
    cx.beginPath();
    cx.arc(x, y, w, 0, 2 * Math.PI);
    cx.fill(); 
}

function image() {
    let img = new Image(), cv = cx.canvas;
    img.onload = function() {
        let err, p = new Plot(cv, [-1, 1, -1, 1]);
        args = prompt("Angle, Size?", "90, 128, 96");
        if (args) {
            try {args = eval(`[${args}]`)}
            catch(err) {args = [0]}
        }
        else args = [0];
        let opt = {anchor:CENTER, rotate:Math.PI/180*args[0]};
        let w = cv.width, h = cv.height;
        if (args.length == 3) {
            w = args[1];
            h = args[2];
        }
        else {
            // let c = Math.abs(Math.cos(opt.rotate));
            // let s = Math.abs(Math.sin(opt.rotate));
            // let w1 = w * c + h * s;
            // let h1 = h * c + w * s;
            let r = Math.abs(args[0]);
            r = r == 90 || r == 270;
            let f = Math.min((r?h:w) / this.width, (r?w:h) / this.height);
            // console.log(f, [w,h], [this.width,this.height]);
            w = Math.round(f * this.width);
            h = Math.round(f * this.height);
        }
        $(this).attr({width:w, height:h});
        p.blit(this, [0, 0], opt);
    }
    img.src = prompt("Source?", "bg.png");
}

$(function() {
    let w = $(window);
    let size = {width:w.width()-2, height:w.height() - 48};
    if (qsArgs("w")) size.width = parseInt(qsArgs("w"));
    if (qsArgs("h")) size.height = parseInt(qsArgs("h"));
    let cv = $("canvas").attr(size)
        .on("mousedown", setPos)
        .on("mousemove", move)
        .on("touchstart", touch)
        .on("touchmove", touch);
    cx = cv[0].getContext('2d');
    cx.lineWidth = 3;
    cx.fillStyle = "black";
    access();
    reset();
})

function color(c) {
    if (!c) c = prompt("Line style?", "black");
    cx.fillStyle = c;
}

function setWidth() {
    cx.lineWidth = prompt("Line width?", 3);
}

function reset() {
    let cv = $("canvas");
    let f = cx.fillStyle;
    cx.fillStyle = "white";
    cx.fillRect(0, 0, parseInt(cv.attr("width")), parseInt(cv.attr("height")));
    cx.fillStyle = f;
    sync();
}

function access() {
    let p = prompt("Access Code?");
    if (p) {
        localStorage.setItem("sync-access", p);
        access.code = p;
    }
    else access.code = localStorage.getItem("sync-access");
}

function sync() {
    let png = $("canvas")[0].toDataURL();
    if (sync.status == 0) {
        sync.status = 1;
        $.ajax(sync.url, {type:"POST", data:{access: access.code, data: png},
            dataType:"text/plain", complete: function(a) {
                console.log(a);
                let pend = sync.status == 2;
                sync.status = 0;
                if (pend) sync();
            }
        });
    }
    else sync.status = 2;
}

sync.status = 0;
sync.url = "https://synctext.davidmaccarthy.repl.co/submit";

function qsArgs(key) {
    let qs = location.search.slice(1).split("&");
    args = {}
    for (let i=0;i<qs.length;i++) {
        let a = qs[i].split("=");
        args[a[0]] = decodeURIComponent(a[1]);
    }
    return key ? args[key] : args;
}

</script>
</head>
<body>
    <canvas width="128" height="128"></canvas>
    <table><tr>
        <td onclick="color('red')" class="red"> </td>
        <td onclick="color('blue')" class="blue"> </td>
        <td onclick="color('forestgreen')" class="green"> </td>
        <td onclick="color('violet')" class="purple"> </td>
        <td onclick="color()" class="black"> </td>
        <td onclick="color('white')"> </td>
        <td onclick="setWidth()">|</td>
        <td onclick="reset()">â†»</td>
        <td onclick="image()">i</td>
    </tr></table>
</body>
</html>
 